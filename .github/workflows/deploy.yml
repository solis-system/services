name: "Docker Deploy"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Nom complet de l'image Docker (ex: registry.solisws.fr/app)"
        required: true
        type: string
      docker_password:
        description: "Docker registry password"
        required: true
        type: string
      service_name:
        description: "Nom du service pour make update (api ou app)"
        required: true
        type: string
      mattermost_webhook:
        description: "Webhook Mattermost (optionnel)"
        required: false
        type: string
      build_args:
        description: "Docker build arguments (optionnel, ex: KEY1=val1,KEY2=val2)"
        required: false
        type: string
      app_display_name:
        description: "Nom d'affichage de l'application (ex: API Laravel, Frontend Vue.js)"
        required: false
        type: string
      prod_url:
        description: "URL de l'environnement de production"
        required: false
        type: string
      test_url:
        description: "URL de l'environnement de test"
        required: false
        type: string
      services_path:
        description: "Chemin vers le dossier services sur le serveur"
        required: false
        type: string
        default: "/home/ubuntu/services"

jobs:
  deploy:
    runs-on: [self-hosted, solis]

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "env=prod" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "env=test" >> $GITHUB_OUTPUT
            echo "tag=test" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Registry
        run: |
          echo '${{ inputs.docker_password }}' | docker login https://registry.solisws.fr -u admin --password-stdin

      - name: Build Docker image
        run: |
          BUILD_ARGS=""
          if [ -n "${{ inputs.build_args }}" ]; then
            IFS=',' read -ra ARGS <<< "${{ inputs.build_args }}"
            for arg in "${ARGS[@]}"; do
              BUILD_ARGS="$BUILD_ARGS --build-arg $arg"
            done
          fi

          docker build $BUILD_ARGS \
            -t ${{ inputs.image_name }}:${{ steps.env.outputs.tag }} \
            .

      - name: Push Docker image
        run: |
          docker push ${{ inputs.image_name }}:${{ steps.env.outputs.tag }}

          # Pour production, aussi pusher avec le tag version
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            git fetch --tags
            TAG=$(git describe --tags "$(git rev-list --tags --max-count=1)" 2>/dev/null || echo "0.0.0")
            IFS='.' read -r -a V <<< "$TAG"
            NEW_TAG="${V[0]:-0}.${V[1]:-0}.$(( ${V[2]:-0} + 1 ))"

            docker tag ${{ inputs.image_name }}:latest ${{ inputs.image_name }}:$NEW_TAG
            docker push ${{ inputs.image_name }}:$NEW_TAG

            # Cr√©er le tag git
            git config --global user.email "actions@github.com"
            git config --global user.name "GitHub Actions"
            git tag "$NEW_TAG" 2>/dev/null || true
            git push origin "$NEW_TAG" 2>/dev/null || true

            echo "version_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Update service on server
        working-directory: ${{ inputs.services_path }}
        run: |
          SERVICE="${{ inputs.service_name }}_${{ steps.env.outputs.env }}"
          echo "üîÑ Updating service: $SERVICE"

          # Pull + recreate le conteneur (sans r√©g√©n√©rer les configs)
          docker compose -f dist/docker-compose.yml -f dist/proxy.docker-compose.yml pull $SERVICE
          docker compose -f dist/docker-compose.yml -f dist/proxy.docker-compose.yml up -d $SERVICE

      - name: Send Mattermost notification
        if: always()
        run: |
          DEFAULT_WEBHOOK="https://mattermost.solisws.fr/hooks/c97qgck97bgz3ju8ueu1gdx5uc"
          WEBHOOK="${{ inputs.mattermost_webhook }}"
          WEBHOOK="${WEBHOOK:-$DEFAULT_WEBHOOK}"

          if [[ "${{ github.ref_name }}" == "main" ]]; then
            SERVICE_URL="${{ inputs.prod_url }}"
            TAG_DISPLAY="${{ steps.env.outputs.tag }}"
          else
            SERVICE_URL="${{ inputs.test_url }}"
            TAG_DISPLAY="${{ steps.env.outputs.tag }}"
          fi

          DISPLAY_NAME="${{ inputs.app_display_name }}"
          IMAGE_SHORT=$(echo "${{ inputs.image_name }}" | awk -F'/' '{print $NF}')
          REGISTRY_URL="https://registry.solisws.fr/#!/taglist/${IMAGE_SHORT}"

          if [[ "${{ job.status }}" == "success" ]]; then
            MESSAGE="#### üöÄ D√©ploiement: **${DISPLAY_NAME}**\nüì¶ Version: [${TAG_DISPLAY}](${REGISTRY_URL})\nüåê Service: ${SERVICE_URL}"
          else
            MESSAGE="#### ‚ùå D√©ploiement √©chou√©: **${DISPLAY_NAME}**\nüîó [Voir les logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi

          curl -s -X POST -H 'Content-Type: application/json' \
               -d "{\"text\":\"${MESSAGE}\"}" \
               "$WEBHOOK" || true
