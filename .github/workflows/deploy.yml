name: "Docker Deploy"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Nom complet de l'image Docker (ex: registry.solisws.fr/app)"
        required: true
        type: string
      docker_password:
        description: "Docker registry password"
        required: true
        type: string
      mattermost_webhook:
        description: "Webhook Mattermost (optionnel)"
        required: false
        type: string
      build_args:
        description: "Docker build arguments (optionnel, ex: KEY1=val1,KEY2=val2)"
        required: false
        type: string
      app_display_name:
        description: "Nom d'affichage de l'application (ex: API Laravel, Frontend Vue.js)"
        required: false
        type: string
      prod_url:
        description: "URL de l'environnement de production"
        required: false
        type: string
      test_url:
        description: "URL de l'environnement de test"
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout du repo appelant (ex: frontend ou backend)
      - name: Checkout target repo
        uses: actions/checkout@v4

# 2️⃣ Checkout du repo services (maintenant public)
      - name: Checkout services repo
        uses: actions/checkout@v4
        with:
          repository: solis-system/services
          ref: main
          path: services

      # 3️⃣ Setup Docker
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 4️⃣ Exécution du scripts du repo services
      - name: Run deploy scripts
        shell: bash
        run: bash services/.github/scripts/deploy.sh
        env:
          DOCKER_PASSWORD: ${{ inputs.docker_password }}
          IMAGE_NAME: ${{ inputs.image_name }}
          MATTERMOST_WEBHOOK: ${{ inputs.mattermost_webhook }}
          BUILD_ARGS: ${{ inputs.build_args }}
          APP_DISPLAY_NAME: ${{ inputs.app_display_name }}
          PROD_URL: ${{ inputs.prod_url }}
          TEST_URL: ${{ inputs.test_url }}
          GITHUB_REF_NAME: ${{ github.ref_name }}