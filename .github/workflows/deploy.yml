name: "Docker Deploy"
description: "Build, tag, push Docker image (test/prod) and send Mattermost notification"
author: "Florian Brotte"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Nom complet de lâ€™image Docker (ex: registry.solisws.fr/app)"
        required: true
      docker_registry:
        description: "URL du registre Docker"
        required: true
      docker_username:
        description: "Nom d'utilisateur du registre Docker"
        required: true
      docker_password:
        description: "Mot de passe du registre Docker"
        required: true
      mattermost_webhook:
        description: "Webhook Mattermost (optionnel)"
        required: false

jobs:
  deploy:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: workflows/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Run deploy script
      shell: bash
      run: bash $GITHUB_ACTION_PATH/entrypoint.sh
      env:
        DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        IMAGE_NAME: ${{ inputs.image_name }}
        MATTERMOST_WEBHOOK: ${{ inputs.mattermost_webhook }}
        GITHUB_REF_NAME: ${{ github.ref_name }}