name: "Docker Deploy"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Nom complet de l’image Docker (ex: registry.solisws.fr/app)"
        required: true
        type: string
      mattermost_webhook:
        description: "Webhook Mattermost (optionnel)"
        required: false
        type: string
    secrets:
      DOCKER_REGISTRY:
        required: true
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout du repo appelant (ex: frontend ou backend)
      - name: Checkout target repo
        uses: actions/checkout@v4

# 2️⃣ Checkout du repo services (maintenant public)
      - name: Checkout services repo
        uses: actions/checkout@v4
        with:
          repository: solis-system/services
          ref: main
          path: services

      # 3️⃣ Setup Docker
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 4️⃣ Exécution du scripts du repo services
      - name: Run deploy scripts
        shell: bash
        run: bash services/.github/scripts/deploy.sh
        env:
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_NAME: ${{ inputs.image_name }}
          MATTERMOST_WEBHOOK: ${{ inputs.mattermost_webhook }}
          GITHUB_REF_NAME: ${{ github.ref_name }}